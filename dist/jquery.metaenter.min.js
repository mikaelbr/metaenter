/**
 *  This jQuery Plugin, metaenter, will allow you to convert regular textareas into divs with content editable,
 *  and have a simular effect as the Facebook message boxes. Submit form on meta key + enter, auto expand box,
 *  and lots more. 
 *  
 *  Documentation: https://github.com/mikaelbr/metaenter#readme
 *  URL: https://github.com/mikaelbr/metaenter
 *  Author: Mikael Brevik <mikaelbre@gmail.com>
 *  Version: 0.1
 *  Date: Tue Feb 28 01:20:17 2012 +0100
 **/
(function(a){a.fn.getPreText=function(){var b=a("<pre />").html(this.html());return a.browser.webkit&&b.find("div").replaceWith(function(){return"\n"+this.innerHTML}),a.browser.msie&&b.find("p").replaceWith(function(){return this.innerHTML+"<br>"}),(a.browser.mozilla||a.browser.opera||a.browser.msie)&&b.find("br").replaceWith("\n"),b.text()};var b={init:function(c){return this.each(function(){var d=a(this),e=d.data("metaenter");if(!e){var f=a.extend({},a.fn.metaenter.defaults,c);f.form||(f.form=d.parents("form")),d.data("metaenter",{_settings:f}),b._render.call(this),b._bindEventHandlers.call(this)}})},_render:function(){var b=a(this),c=b.data("metaenter");if(c._settings.useDiv)$elm=a("<div />",{contenteditable:"true"}).insertBefore(b),b.hide(),$elm.css({"min-height":c._settings.minHeight,"max-height":c._settings.maxHeight});else{$elm=b;var d=$elm.css("font-size"),e=Math.floor(parseInt(d.replace("px",""),10)*1.5),f=parseInt($elm.css("padding-bottom").replace("px",""),10),g=Math.ceil((c._settings.minHeight-f)/e)*e;$elm.height(g)}if(c._settings.useFacebookStyle){var h=c._settings.form.find("input.metaenter-return-button").parent();if(!h.length){var i=a('<label><input type="checkbox" class="metaenter-return-button">'+c._settings.checkBoxTxt+"</label>"),j=c._settings.form.find("[type='submit']");c.checkBoxLbl=i.insertAfter(j),c._settings.checkBoxOnByDefault&&(i.children("input").attr("checked","checked"),j.hide())}else c.checkBoxLbl=h,c._doNotAddCheckBoxEvent=!0}$elm.addClass("metaenter-message-box"),b.addClass("metaenter-init"),c._settings.useCounter&&(c.counterSpan=a("<span />",{"class":"metaenter-counter",text:"0"}).insertAfter($elm)),c.target=$elm},_expandTextarea:function(b){var c=a(this),d=c.data("metaenter"),e=parseInt(c.css("padding-bottom").replace("px",""),10);if(c.height()<d._settings.maxHeight&&c.get(0).scrollHeight>c.outerHeight()){var f=c.css("font-size"),g=Math.floor(parseInt(f.replace("px",""),10)*1.5);c.height(c.height()+g)}},_bindEventHandlers:function(){var c=a(this),d=c.data("metaenter");d.target.on("keydown",function(a){b._doNewLineOrSubmit.call(c,a)}),d._settings.useCounter&&(d.target.on("keyup",function(a){b._countLettersTyped.call(c,a)}),c.on("metaenter.newtype",b._updateLetterCounter)),d._settings.useDiv?d._settings.form.on("submit",function(a){b._mapValuesFromDivToTextarea.call(c,a)}):c.on("keyup",b._expandTextarea),d._settings.useFacebookStyle&&!d._doNotAddCheckBoxEvent&&d.checkBoxLbl.children("input").on("change",function(a){b._toggleButtonVisibility.call(c,a)})},_toggleButtonVisibility:function(b){var c=a(this),d=c.data("metaenter"),e=!d.checkBoxLbl||d.checkBoxLbl.children("input").is(":checked");d._settings.form.find("[type='submit']").toggle()},_mapValuesFromDivToTextarea:function(b){var c=a(this),d=c.data("metaenter");c.val(d.target.getPreText())},_countLettersTyped:function(b){var c=a(this),d=c.data("metaenter");d._settings.useDiv?d.letters=d.target.getPreText().length:d.letters=d.target.val().length,c.trigger("metaenter.newtype")},_updateLetterCounter:function(){var b=a(this),c=b.data("metaenter");c.counterSpan.text(c.letters)},_doNewLineOrSubmit:function(b){var c=a(this),d=c.data("metaenter"),e=!d.checkBoxLbl||d.checkBoxLbl.children("input").is(":checked");return e&&b.shiftKey&&b.keyCode===13?!0:b.keyCode===13&&(b.metaKey||e)?(d._settings.form.submit(),b.preventDefault(),!1):!0},options:function(b){var c=a(this),d=c.data("metaenter");return b?(d._settings=a.extend({},d._settings,b),this):d._settings},remove:function(b){var c=a(this).data("metaenter");a("div.metaenter-message-box").remove(),c.checkBoxLbl.remove(),c.counterSpan.remove(),a(this).removeClass("metaenter-message-box").removeClass("metaenter-init").data("metatuone",undefined)},numLetters:function(){return a(this).data("metaenter").letters}};a.fn.metaenter=function(c){return typeof c=="string"&&c.substr(0,1)!=="_"&&b[c]?b[c].apply(this,Array.prototype.slice.call(arguments,1)):typeof c=="object"||!c?b.init.apply(this,arguments):(a.error("Method "+c+" does not exist on jQuery.metaenter"),this)},a.fn.metaenter.defaults={useDiv:!0,useFacebookStyle:!0,useCounter:!0,form:!1,minHeight:40,maxHeight:400,checkBoxTxt:"Submit form on return",checkBoxOnByDefault:!1}})(jQuery);